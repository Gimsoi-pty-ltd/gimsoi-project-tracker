---
name: CI Pipeline

"on":
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:
  # Allows manual triggering from the Actions tab

# Ensures tests only have the ability to read but not make changes to tests
permissions:
  contents: read

# Cancels old test build to improve speed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ------------------------------------------------------------------
  # JOB 1: CHECK CI SYNTAX (Ensures workflow file structure is correct)
  # ------------------------------------------------------------------
  lint-ci:
    name: Lint CI Config
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check YAML Syntax
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: .github/workflows/
          strict: true

  # ------------------------------------------------------------------
  # JOB 2: SECURITY
  # ------------------------------------------------------------------
  security:
    name: Security & Secret Scan
    runs-on: ubuntu-latest
    needs: lint-ci
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Allows Gitleaks to scan from beginning of repo history
          fetch-depth: 0

      # 1. Block dangerous files immediately
      - name: Block Prohibited File Types
        run: |
          FORBIDDEN_FILES=$(find . -type f \
            \( -name "*.env" -o -name "*.pem" -o -name "*.key" \) \
            -not -path "*/node_modules/*")

          if [ -n "$FORBIDDEN_FILES" ]; then
            echo "::error title=Prohibited Files::Remove these files:"
            echo "$FORBIDDEN_FILES"
            exit 1
          fi
          echo "No prohibited file extensions found."

      # 2. SCAN: Detect secrets using Gitleaks (Free Workaround)
      - name: Gitleaks Secret Scan
        run: |
          # Install (One-liner style)
          ver="v8.18.4"
          # Broken into multiple lines to satisfy linter line-length limits
          base="https://github.com/gitleaks/gitleaks/releases/download"
          url="$base/${ver}/gitleaks_8.18.4_linux_x64.tar.gz"
          wget -qO- "$url" | tar xvz && sudo mv gitleaks /usr/local/bin/

          # Scan
          gitleaks detect \
            --source . \
            --config .gitleaks.toml \
            --verbose \
            --redact

      # 3. VERIFY: Ensure CI masks secrets in logs
      - name: Verify Secret Masking
        env:
          TEST_SECRET: ${{ secrets.FIREBASE_API_KEY_TEST }}
        run: |
          if [ -z "$TEST_SECRET" ]; then
             echo "::warn::FIREBASE_API_KEY_TEST missing. Skipping."
          else
             echo "Testing secret masking..."
             echo "The secret value is: $TEST_SECRET"
             echo "If you see '***' above, masking is working."
          fi

      # 4. REMEDIATE: Point to docs if any step above failed
      - name: Security Remediation Steps
        if: failure()
        run: |
          echo "::error title=Security Check Failed::STOP! DO NOT IGNORE."
          echo "========================================================"
          echo "You have committed a secret or a prohibited file."
          echo "HOW TO FIX THIS:"
          echo "1. Read the guide: docs/security/handling-secrets.md"
          echo "2. If it's a file (.env), remove it: 'git rm .env'"
          echo "3. If it's a secret string, rotate the key immediately."
          echo "========================================================"

  # ------------------------------------------------------------------
  # JOB 3: BACKEND
  # ------------------------------------------------------------------
  backend:
    name: Backend Checks
    runs-on: ubuntu-latest

    # Prevents testing backend if security fails
    needs: security
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Backend Lint
        run: echo "placeholder - backend lint"

      - name: Backend Test
        run: echo "placeholder - backend test"

      - name: Backend Build
        run: echo "placeholder - backend build"

  # ------------------------------------------------------------------
  # JOB 4: FRONTEND
  # ------------------------------------------------------------------
  frontend:
    name: Frontend Checks
    runs-on: ubuntu-latest

    # Prevents testing frontend if security fails
    needs: security
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Frontend Lint
        run: echo "placeholder - frontend lint"

      - name: Frontend Test
        run: echo "placeholder - frontend test"

      - name: Frontend Build
        run: echo "placeholder - frontend build"
